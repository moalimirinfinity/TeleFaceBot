# TeleFaceBot

A Telegram bot designed to find faces in photos similar to a provided photo, using pre-indexed embeddings from other Telegram messages (e.g., from a channel or group). It leverages `facenet-pytorch` for face detection and embedding generation and `pyrogram` for interacting with the Telegram API.

This version has been refactored for better configuration and modularity.

## Features

*   Accepts photos via private message.
*   Detects faces in the submitted photo.
*   Compares detected faces against a pre-built index of face embeddings.
*   Forwards the original messages containing the most similar faces.
*   Uses a `.env` file for configuration.
*   Separates face processing logic (`processing.py`) from bot logic (`bot.py`).

## Project Structure

```
.
├── .env                # Configuration file (you need to create this)
├── bot.py              # Main Pyrogram bot application logic
├── processing.py       # Face detection, embedding, and similarity functions
├── downloader.py       # Script to download media (needs specific chat ID)
├── indexer.ipynb       # Jupyter notebook to create face embedding indexes (.pkl files)
├── README.md           # This file
└── ...                 # Other files (e.g., index files, downloaded data)
```

## Setup

### 1. Prerequisites

*   Python 3.8+
*   Telegram API Credentials:
    *   `API ID` and `API Hash` from [my.telegram.org](https://my.telegram.org/apps)
    *   `Bot Token` from [@BotFather](https://t.me/BotFather) on Telegram.

### 2. Installation

Clone the repository and install the required Python packages:

```bash
git clone <your-repo-url>
cd <repository-folder>
pip install -r requirements.txt 
# Or install manually:
# pip install pyrogram Pillow facenet-pytorch torch torchvision opencv-python python-dotenv numpy
```
*(Note: You might need specific versions of `torch` and `torchvision` depending on your system and CUDA setup if using a GPU. Check the PyTorch website for installation instructions.)*

### 3. Configuration

Create a `.env` file in the root directory of the project. You can copy the example below and fill in your actual values:

```dotenv
# .env file

# Telegram API Credentials (get from my.telegram.org)
API_ID=YOUR_API_ID
API_HASH=YOUR_API_HASH

# Telegram Bot Token (get from @BotFather)
BOT_TOKEN=YOUR_BOT_TOKEN

# Proxy Settings (optional, JSON format, leave empty {} if none)
# Example: PROXY={"scheme": "socks5", "hostname": "127.0.0.1", "port": 1080}
PROXY={}

# Path to index files (comma-separated list of .pkl files generated by indexer.ipynb)
INDEX_FILES=index1.pkl,index2.pkl 
```

**Important:**
*   Replace `YOUR_API_ID`, `YOUR_API_HASH`, and `YOUR_BOT_TOKEN` with your actual credentials.
*   Adjust `PROXY` if you need to use a proxy. It must be a valid JSON string or `{}`.
*   Update `INDEX_FILES` to point to the actual index files you generate in the next steps.

### 4. Data Download and Indexing

*   **(Optional/Customize)** Run `downloader.py`: This script currently requires manual modification to specify the target chat ID from which to download media. Adapt it for your needs or use another method to gather the images you want to index. Downloaded images are typically saved to a `data` directory.
*   **Run `indexer.ipynb`:** This Jupyter notebook processes the downloaded images (e.g., in the `data` directory), detects faces, generates embeddings, and saves them into `.pkl` index files. Ensure the notebook reads from the correct image directory and saves the index files (e.g., `index1.pkl`, `index2.pkl`). Update the `INDEX_FILES` variable in your `.env` file accordingly.

### 5. Running the Bot

Once the `.env` file is configured and the index files are generated and listed in `.env`, you can run the bot:

```bash
python bot.py
```

The bot will load the configuration, initialize the models, load the index files, and start listening for incoming photos.

## Basic Usage

1.  Start a chat with your bot on Telegram.
2.  Send the `/start` command (or `/help`).
3.  Send a photo containing a face you want to search for.
4.  The bot will process the photo, search the index, and display a button to view similar images.
5.  Click the button to see the original messages containing the matching faces forwarded to you.

## Credits

*   Built upon the foundation provided by [AlisaLC's repository]([https://github.com/AlisaLC](https://github.com/AlisaLC/FaceGalleryTelegramBot))
*   Uses `facenet-pytorch` for MTCNN and FaceNet implementations.
*   Uses `pyrogram` for Telegram API interaction.
